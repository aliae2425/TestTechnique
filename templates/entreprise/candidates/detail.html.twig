{% extends 'base/base.html.twig' %}

{% set session = invitation.quizSession %}
{% set isCompleted = session and session.endAt is not null %}

{% block title %}
    Résultats — {% if session %}{{ session.participantName }}{% else %}Candidat{% endif %}
{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-50/50 pt-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        {# Back button #}
        <a href="{{ path('business_candidates_list') }}"
           class="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-slate-800 mb-6 transition-colors">
            <twig:ux:icon name="tabler:arrow-left" class="w-4 h-4" />
            Retour aux candidats
        </a>

        {# Header card #}
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">

                {# Avatar #}
                <div class="w-14 h-14 rounded-2xl bg-cyan-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-xl font-bold text-cyan-700 uppercase">
                        {% if session %}{{ session.participantName|first }}{% elseif invitation.prenom %}{{ invitation.prenom|first }}{% else %}?{% endif %}
                    </span>
                </div>

                {# Identity #}
                <div class="flex-1">
                    <h1 class="text-xl font-bold text-slate-900">
                        {% if session %}
                            {{ session.participantName }}
                        {% elseif invitation.prenom or invitation.nom %}
                            {{ invitation.prenom }} {{ invitation.nom }}
                        {% else %}
                            Candidat anonyme
                        {% endif %}
                    </h1>
                    {% if invitation.email %}
                        <p class="text-sm text-slate-500 mt-0.5">{{ invitation.email }}</p>
                    {% endif %}
                    <div class="flex items-center gap-2 mt-1">
                        {% if invitation.type == 'link' %}
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-violet-100 text-violet-700">
                                <twig:ux:icon name="tabler:link" class="w-3 h-3" />
                                Lien
                            </span>
                        {% else %}
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-700">
                                <twig:ux:icon name="tabler:mail" class="w-3 h-3" />
                                Email
                            </span>
                        {% endif %}
                    </div>
                </div>

                {# Score block #}
                {% if isCompleted and session.finalScore is not null %}
                    <div class="flex flex-col items-center justify-center px-6 py-4 rounded-xl
                        {% if totalQuestions > 0 and (session.finalScore / totalQuestions) >= 0.7 %}bg-green-50 border border-green-200
                        {% elseif totalQuestions > 0 and (session.finalScore / totalQuestions) >= 0.4 %}bg-amber-50 border border-amber-200
                        {% else %}bg-red-50 border border-red-200{% endif %}">
                        <span class="text-3xl font-black
                            {% if totalQuestions > 0 and (session.finalScore / totalQuestions) >= 0.7 %}text-green-600
                            {% elseif totalQuestions > 0 and (session.finalScore / totalQuestions) >= 0.4 %}text-amber-600
                            {% else %}text-red-500{% endif %}">
                            {{ session.finalScore|number_format(0) }}/{{ totalQuestions }}
                        </span>
                        <span class="text-xs font-medium text-slate-500 mt-0.5">bonnes réponses</span>
                        {% if totalQuestions > 0 %}
                            <span class="text-xs font-bold
                                {% if (session.finalScore / totalQuestions) >= 0.7 %}text-green-600
                                {% elseif (session.finalScore / totalQuestions) >= 0.4 %}text-amber-600
                                {% else %}text-red-500{% endif %}">
                                {{ ((session.finalScore / totalQuestions) * 100)|number_format(0) }}%
                            </span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            {# Meta row #}
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6 pt-6 border-t border-slate-50">
                <div>
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wide mb-1">Quiz</p>
                    <p class="text-sm font-semibold text-slate-700">
                        {{ invitation.quizTemplate ? invitation.quizTemplate.titre : '—' }}
                    </p>
                    {% if invitation.quizTemplate %}
                        <p class="text-xs text-slate-400">{{ invitation.quizTemplate.type }}</p>
                    {% endif %}
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wide mb-1">Début</p>
                    <p class="text-sm font-semibold text-slate-700">
                        {{ session ? session.startAt|date('d/m/Y') : '—' }}
                    </p>
                    {% if session %}
                        <p class="text-xs text-slate-400">{{ session.startAt|date('H:i') }}</p>
                    {% endif %}
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wide mb-1">Durée</p>
                    <p class="text-sm font-semibold text-slate-700">
                        {{ isCompleted ? session.durationString : '—' }}
                    </p>
                </div>
                <div>
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wide mb-1">Statut</p>
                    {% if isCompleted %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <twig:ux:icon name="tabler:circle-check" class="w-3 h-3" />
                            Terminé
                        </span>
                    {% elseif session %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            <twig:ux:icon name="tabler:clock-play" class="w-3 h-3" />
                            En cours
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
                            <twig:ux:icon name="tabler:clock" class="w-3 h-3" />
                            En attente
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Results by question #}
        {% if resultsByQuestion is not empty %}
            <h2 class="text-lg font-bold text-slate-800 mb-4">Détail des réponses</h2>

            <div class="space-y-4">
                {% set qIndex = 0 %}
                {% for qId, result in resultsByQuestion %}
                    {% set qIndex = qIndex + 1 %}
                    <div class="bg-white rounded-xl border {% if result.isCorrect %}border-green-200{% else %}border-red-200{% endif %} shadow-sm overflow-hidden">

                        {# Question header #}
                        <div class="flex items-start gap-3 p-4 {% if result.isCorrect %}bg-green-50/60{% else %}bg-red-50/60{% endif %}">
                            <div class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold
                                {% if result.isCorrect %}bg-green-600 text-white{% else %}bg-red-500 text-white{% endif %}">
                                {{ qIndex }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-slate-800">{{ result.question.titled }}</p>
                                {% if result.question.level %}
                                    <span class="text-xs text-slate-400 mt-0.5 inline-block">{{ result.question.level }}</span>
                                {% endif %}
                            </div>
                            <div class="flex-shrink-0">
                                {% if result.isCorrect %}
                                    <span class="inline-flex items-center gap-1 text-xs font-medium text-green-700">
                                        <twig:ux:icon name="tabler:circle-check" class="w-4 h-4" />
                                        Correct
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center gap-1 text-xs font-medium text-red-600">
                                        <twig:ux:icon name="tabler:circle-x" class="w-4 h-4" />
                                        Incorrect
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        {# Answers #}
                        <div class="p-4 space-y-2">
                            {% set selectedIds = result.selectedAnswers|map(a => a.id) %}
                            {% for answer in result.question.reponses %}
                                {% set isSelected = answer.id in selectedIds %}
                                {% set isCorrectAnswer = answer.isCorrect %}
                                <div class="flex items-start gap-2.5 px-3 py-2 rounded-lg text-sm
                                    {% if isSelected and isCorrectAnswer %}bg-green-50 border border-green-200 text-green-800
                                    {% elseif isSelected and not isCorrectAnswer %}bg-red-50 border border-red-200 text-red-700
                                    {% elseif not isSelected and isCorrectAnswer %}bg-green-50/40 border border-green-100 text-green-700
                                    {% else %}border border-transparent text-slate-500{% endif %}">
                                    <div class="w-4 h-4 mt-0.5 flex-shrink-0">
                                        {% if isSelected and isCorrectAnswer %}
                                            <twig:ux:icon name="tabler:circle-check-filled" class="w-4 h-4 text-green-600" />
                                        {% elseif isSelected and not isCorrectAnswer %}
                                            <twig:ux:icon name="tabler:circle-x-filled" class="w-4 h-4 text-red-500" />
                                        {% elseif not isSelected and isCorrectAnswer %}
                                            <twig:ux:icon name="tabler:circle-dotted" class="w-4 h-4 text-green-500" />
                                        {% else %}
                                            <twig:ux:icon name="tabler:circle" class="w-4 h-4 text-slate-300" />
                                        {% endif %}
                                    </div>
                                    <span class="flex-1">{{ answer.text }}</span>
                                    {% if isSelected %}
                                        <span class="text-xs font-medium {% if isCorrectAnswer %}text-green-600{% else %}text-red-500{% endif %} flex-shrink-0">
                                            {% if isCorrectAnswer %}✓{% else %}✗{% endif %} Sélectionné
                                        </span>
                                    {% elseif isCorrectAnswer %}
                                        <span class="text-xs font-medium text-green-600 flex-shrink-0">Bonne réponse</span>
                                    {% endif %}
                                </div>
                                {% if answer.feedback and (isSelected or isCorrectAnswer) %}
                                    <p class="ml-7 text-xs text-slate-500 italic mt-1 pb-1">{{ answer.feedback }}</p>
                                {% endif %}
                            {% endfor %}
                        </div>

                    </div>
                {% endfor %}
            </div>

        {% elseif session %}
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-10 text-center">
                <twig:ux:icon name="tabler:file-unknown" class="w-10 h-10 text-slate-300 mx-auto mb-3" />
                <p class="text-sm text-slate-500">Le détail des réponses n'est pas disponible.</p>
            </div>
        {% else %}
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-10 text-center">
                <twig:ux:icon name="tabler:hourglass" class="w-10 h-10 text-slate-300 mx-auto mb-3" />
                <p class="text-sm text-slate-500">Le candidat n'a pas encore commencé le quiz.</p>
            </div>
        {% endif %}

    </div>
</div>
{% endblock %}
