{% extends '@EasyAdmin/crud/index.html.twig' %}

{% block content_title %}
    {{ parent() }}
{% endblock %}

{% block main %}
    {% set currentView = app.request.query.get('view', 'list') %}

    <div class="mb-4">
        {# Top Level Tabs: Home vs List #}
        <ul class="nav nav-pills mb-3 p-2 border-bottom" role="tablist">
             <li class="nav-item">
                <a class="nav-link {{ currentView == 'list' ? 'active' : '' }}" href="{{ ea_url().unset('view') }}">
                    <i class="fas fa-list me-2"></i> Liste des questions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {{ currentView == 'home' ? 'active' : '' }}" href="{{ ea_url().set('view', 'home').unset('filters') }}">
                    <i class="fas fa-chart-bar me-2"></i> Statistiques (Home)
                </a>
            </li>
        </ul>

        {% if currentView == 'home' %}
            {# STATS VIEW #}
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body" data-controller="ajax-modal">
                    <h5 class="card-title mb-4">Statistiques par Question</h5>
                    {% if questionStats is defined and questionStats|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    {% set sortField = app.request.query.get('sort_field', 'totalAttempts') %}
                                    {% set sortOrder = app.request.query.get('sort_order', 'DESC') %}
                                    
                                    <tr>
                                        <th>
                                            <a href="{{ ea_url().set('view', 'home').set('sort_field', 'id').set('sort_order', sortField == 'id' and sortOrder == 'DESC' ? 'ASC' : 'DESC') }}" class="text-decoration-none text-dark">
                                                ID
                                                {% if sortField == 'id' %}
                                                    <i class="fas fa-arrow-{{ sortOrder == 'ASC' ? 'up' : 'down' }} small ms-1"></i>
                                                {% else %}
                                                     <i class="fas fa-sort text-muted ms-1 small" style="opacity: 0.3"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th>Question</th>
                                        <th>Niveau</th>
                                        <th class="text-center">
                                            <a href="{{ ea_url().set('view', 'home').set('sort_field', 'totalAttempts').set('sort_order', sortField == 'totalAttempts' and sortOrder == 'DESC' ? 'ASC' : 'DESC') }}" class="text-decoration-none text-dark">
                                                Réponses (Total)
                                                {% if sortField == 'totalAttempts' %}
                                                    <i class="fas fa-arrow-{{ sortOrder == 'ASC' ? 'up' : 'down' }} small ms-1"></i>
                                                {% else %}
                                                     <i class="fas fa-sort text-muted ms-1 small" style="opacity: 0.3"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">Correctes</th>
                                        <th class="text-center">
                                            <a href="{{ ea_url().set('view', 'home').set('sort_field', 'successRate').set('sort_order', sortField == 'successRate' and sortOrder == 'DESC' ? 'ASC' : 'DESC') }}" class="text-decoration-none text-dark">
                                                Taux de succès
                                                {% if sortField == 'successRate' %}
                                                    <i class="fas fa-arrow-{{ sortOrder == 'ASC' ? 'up' : 'down' }} small ms-1"></i>
                                                {% else %}
                                                     <i class="fas fa-sort text-muted ms-1 small" style="opacity: 0.3"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in questionStats %}
                                        {% set successRate = stat.totalAttempts > 0 ? (stat.correctCount / stat.totalAttempts) * 100 : 0 %}
                                        <tr>
                                            <td>#{{ stat.id }}</td>
                                            <td style="max-width: 300px;">
                                                <div class="fw-bold text-truncate" title="{{ stat.titled }}">{{ stat.titled }}</div>
                                                <small class="text-muted">{{ stat.type }}</small>
                                            </td>
                                            <td>
                                                <span class="badge badge-secondary">{{ stat.level }}</span>
                                            </td>
                                            <td class="text-center fw-bold">{{ stat.totalAttempts }}</td>
                                            <td class="text-center text-success">{{ stat.correctCount }}</td>
                                            <td class="text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <span class="me-2 fw-bold text-{{ successRate >= 50 ? 'success' : 'danger' }}">{{ successRate|round(1) }}%</span>
                                                    <div class="progress" style="width: 50px; height: 6px;">
                                                        <div class="progress-bar bg-{{ successRate >= 50 ? 'success' : 'danger' }}" role="progressbar" style="width: {{ successRate }}%"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-info text-white" 
                                                        data-action="click->ajax-modal#open"
                                                        data-url="{{ path('admin_question_stats_ajax', {id: stat.id}) }}">
                                                    <i class="fas fa-chart-pie me-1"></i> Détails
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Modal Container for Ajax Content -->
                        <div class="modal fade" id="ajaxModal" tabindex="-1" aria-labelledby="ajaxModalLabel" aria-hidden="true" data-ajax-modal-target="modal">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="ajaxModalLabel" data-ajax-modal-target="title">Chargement...</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" data-ajax-modal-target="modalBody">
                                        <div class="text-center p-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Aucune statistique disponible (Aucune réponse enregistrée).
                        </div>
                    {% endif %}
                </div>
            </div>
        {% else %}            
            {{ parent() }}
        {% endif %}
    </div>
{% endblock %}
