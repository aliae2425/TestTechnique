{% extends 'base/base.html.twig' %}

{% block title %}Gérer mes tests — {{ company.name }}{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-50/50 pt-20">
<div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">

    {# ——————————————————————————————————————
       HEADER
    —————————————————————————————————————— #}
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Gérer mes tests</h1>
            <p class="text-sm text-slate-500 mt-0.5">{{ company.name }}</p>
        </div>
        <button type="button" onclick="openInviteModal()"
                class="inline-flex items-center gap-2 px-4 py-2.5 bg-cyan-600 text-white text-sm font-semibold rounded-xl hover:bg-cyan-700 transition-colors shadow-sm">
            <twig:ux:icon name="tabler:send" class="w-4 h-4" />
            Lancer un test
        </button>
    </div>

    {# Flash messages #}
    {% for msg in app.flashes('success') %}
        <div class="mb-4 flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-xl text-sm text-green-800">
            <twig:ux:icon name="tabler:circle-check" class="w-4 h-4 flex-shrink-0 text-green-600" />{{ msg }}
        </div>
    {% endfor %}
    {% for msg in app.flashes('error') %}
        <div class="mb-4 flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800">
            <twig:ux:icon name="tabler:alert-circle" class="w-4 h-4 flex-shrink-0 text-red-500" />{{ msg }}
        </div>
    {% endfor %}

    {# ——————————————————————————————————————
       TABS
    —————————————————————————————————————— #}
    <div class="flex gap-1 mb-6 bg-white rounded-xl border border-slate-100 shadow-sm p-1 w-fit">
        <button id="tab-btn-quiz" onclick="switchTab('quiz')"
                class="tab-btn px-5 py-2 rounded-lg text-sm font-semibold transition-all">
            <twig:ux:icon name="tabler:layout-list" class="w-4 h-4 inline mr-1.5" />
            Quiz <span class="ml-1 text-xs opacity-60">({{ companyQuizzes|length }})</span>
        </button>
        <button id="tab-btn-questions" onclick="switchTab('questions')"
                class="tab-btn px-5 py-2 rounded-lg text-sm font-semibold transition-all">
            <twig:ux:icon name="tabler:help-circle" class="w-4 h-4 inline mr-1.5" />
            Questions <span class="ml-1 text-xs opacity-60">({{ companyQuestions|length }})</span>
        </button>
    </div>

    {# ——————————————————————————————————————
       TWO-COLUMN LAYOUT
    —————————————————————————————————————— #}
    <div class="flex gap-5 min-h-[calc(100vh-280px)]">

        {# =================== LEFT PANEL — QUIZ TAB =================== #}
        <div id="left-quiz" class="tab-left w-72 flex-shrink-0 flex flex-col gap-3">

            {# New quiz button #}
            <button onclick="showQuizPanel('panel-new-quiz')"
                    class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-cyan-600 text-white text-sm font-semibold rounded-xl hover:bg-cyan-700 transition-colors shadow-sm">
                <twig:ux:icon name="tabler:plus" class="w-4 h-4" />
                Nouveau quiz
            </button>

            {# Company quizzes #}
            {% if companyQuizzes is not empty %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="px-3 py-2 bg-slate-50/70 border-b border-slate-100 flex items-center gap-1.5">
                        <twig:ux:icon name="tabler:building" class="w-3.5 h-3.5 text-cyan-600" />
                        <span class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Vos quiz</span>
                    </div>
                    <div class="divide-y divide-slate-50">
                        {% for quiz in companyQuizzes %}
                            <div class="quiz-item group flex items-center gap-2 px-3 py-2.5 hover:bg-slate-50 cursor-pointer transition-colors"
                                 onclick="showQuizPanel('panel-quiz-{{ quiz.id }}')">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-800 truncate">{{ quiz.titre }}</p>
                                    <div class="flex items-center gap-1.5 mt-0.5">
                                        <span class="text-xs text-slate-400">{{ quiz.mode }}</span>
                                        <span class="text-slate-300">·</span>
                                        <span class="text-xs text-slate-400">{{ quiz.questions|length + quiz.rules|length }} élém.</span>
                                    </div>
                                </div>
                                <twig:ux:icon name="tabler:chevron-right" class="w-3.5 h-3.5 text-slate-300 group-hover:text-slate-500 flex-shrink-0" />
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {# Platform quizzes (read-only) #}
            {% if platformQuizzes is not empty %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="px-3 py-2 bg-slate-50/70 border-b border-slate-100 flex items-center gap-1.5">
                        <twig:ux:icon name="tabler:globe" class="w-3.5 h-3.5 text-violet-500" />
                        <span class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Quiz plateforme</span>
                    </div>
                    <div class="divide-y divide-slate-50">
                        {% for quiz in platformQuizzes %}
                            <div class="group flex items-center gap-2 px-3 py-2.5 hover:bg-slate-50 cursor-pointer transition-colors"
                                 onclick="showQuizPanel('panel-platform-quiz-{{ quiz.id }}')">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-700 truncate">{{ quiz.titre }}</p>
                                    <span class="text-xs text-slate-400">{{ quiz.mode }}</span>
                                </div>
                                <twig:ux:icon name="tabler:eye" class="w-3.5 h-3.5 text-slate-300 group-hover:text-slate-500 flex-shrink-0" />
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if companyQuizzes is empty and platformQuizzes is empty %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-6 text-center">
                    <twig:ux:icon name="tabler:layout-list" class="w-8 h-8 text-slate-300 mx-auto mb-2" />
                    <p class="text-sm text-slate-400">Aucun quiz disponible.</p>
                </div>
            {% endif %}
        </div>

        {# =================== LEFT PANEL — QUESTIONS TAB =================== #}
        <div id="left-questions" class="tab-left w-72 flex-shrink-0 flex flex-col gap-3" style="display:none">

            {# Filters #}
            <form method="GET" action="{{ path('business_quiz_index') }}" class="bg-white rounded-xl border border-slate-100 shadow-sm p-3 space-y-2">
                <input type="hidden" name="tab" value="questions">
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide block mb-1">Niveau</label>
                    <select name="level" class="w-full text-sm border border-slate-200 rounded-lg px-2.5 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="">Tous</option>
                        {% for lvl in ['Facile', 'Moyen', 'Difficile'] %}
                            <option value="{{ lvl }}" {% if filterLevel == lvl %}selected{% endif %}>{{ lvl }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide block mb-1">Thème</label>
                    <select name="type" class="w-full text-sm border border-slate-200 rounded-lg px-2.5 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="">Tous</option>
                        {% for theme in ['Modélisation','Documentation','Collaboration','Coordination','Plugins'] %}
                            <option value="{{ theme }}" {% if filterType == theme %}selected{% endif %}>{{ theme }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500 uppercase tracking-wide block mb-1">Source</label>
                    <select name="owner" class="w-full text-sm border border-slate-200 rounded-lg px-2.5 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="all" {% if filterOwner == 'all' %}selected{% endif %}>Toutes</option>
                        <option value="company" {% if filterOwner == 'company' %}selected{% endif %}>Vos questions</option>
                    </select>
                </div>
                <button type="submit" class="w-full py-1.5 text-xs font-semibold text-cyan-700 bg-cyan-50 border border-cyan-200 rounded-lg hover:bg-cyan-100 transition-colors">
                    Filtrer
                </button>
            </form>

            {# New question button #}
            <button onclick="showQuestionPanel('panel-new-question')"
                    class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-violet-600 text-white text-sm font-semibold rounded-xl hover:bg-violet-700 transition-colors shadow-sm">
                <twig:ux:icon name="tabler:plus" class="w-4 h-4" />
                Nouvelle question
            </button>

            {# Company questions #}
            {% if companyQuestions is not empty %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="px-3 py-2 bg-violet-50/70 border-b border-violet-100 flex items-center gap-1.5">
                        <twig:ux:icon name="tabler:building" class="w-3.5 h-3.5 text-violet-600" />
                        <span class="text-xs font-semibold text-violet-700 uppercase tracking-wide">Vos questions</span>
                    </div>
                    <div class="divide-y divide-slate-50 max-h-72 overflow-y-auto">
                        {% for question in companyQuestions %}
                            <div class="question-item group flex items-center gap-2 px-3 py-2.5 hover:bg-slate-50 cursor-pointer transition-colors"
                                 onclick="loadQuestionStats({{ question.id }}, this)"
                                 data-qid="{{ question.id }}">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-slate-800 truncate leading-snug">{{ question.titled }}</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        {% if question.level %}
                                            <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium
                                                {% if question.level == 'Facile' %}bg-green-100 text-green-700
                                                {% elseif question.level == 'Moyen' %}bg-amber-100 text-amber-700
                                                {% else %}bg-red-100 text-red-600{% endif %}">
                                                {{ question.level }}
                                            </span>
                                        {% endif %}
                                        {% if question.type %}
                                            <span class="text-[10px] text-slate-400">{{ question.type }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {# Platform questions #}
            {% if platformQuestions is not empty and filterOwner != 'company' %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="px-3 py-2 bg-slate-50/70 border-b border-slate-100 flex items-center gap-1.5">
                        <twig:ux:icon name="tabler:globe" class="w-3.5 h-3.5 text-slate-400" />
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Plateforme</span>
                    </div>
                    <div class="divide-y divide-slate-50 max-h-72 overflow-y-auto">
                        {% for question in platformQuestions %}
                            <div class="question-item group flex items-center gap-2 px-3 py-2.5 hover:bg-slate-50 cursor-pointer transition-colors"
                                 onclick="loadQuestionStats({{ question.id }}, this)"
                                 data-qid="{{ question.id }}">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-slate-700 truncate leading-snug">{{ question.titled }}</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        {% if question.level %}
                                            <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium
                                                {% if question.level == 'Facile' %}bg-green-100 text-green-700
                                                {% elseif question.level == 'Moyen' %}bg-amber-100 text-amber-700
                                                {% else %}bg-red-100 text-red-600{% endif %}">
                                                {{ question.level }}
                                            </span>
                                        {% endif %}
                                        {% if question.type %}
                                            <span class="text-[10px] text-slate-400">{{ question.type }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if companyQuestions is empty and platformQuestions is empty %}
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-6 text-center">
                    <twig:ux:icon name="tabler:help-circle" class="w-8 h-8 text-slate-300 mx-auto mb-2" />
                    <p class="text-sm text-slate-400">Aucune question trouvée.</p>
                </div>
            {% endif %}
        </div>

        {# =================== RIGHT PANEL — QUIZ TAB =================== #}
        <div id="right-quiz" class="tab-right flex-1 min-w-0">

            {# Welcome state #}
            <div id="panel-welcome-quiz" class="quiz-panel bg-white rounded-2xl border border-slate-100 shadow-sm p-12 text-center h-full flex flex-col items-center justify-center" style="display:none">
                <twig:ux:icon name="tabler:layout-list" class="w-12 h-12 text-slate-300 mb-4" />
                <p class="text-slate-500 font-medium">Sélectionnez un quiz ou créez-en un nouveau</p>
            </div>

            {# NEW QUIZ FORM #}
            <div id="panel-new-quiz" class="quiz-panel bg-white rounded-2xl border border-slate-100 shadow-sm">
                <div class="px-6 py-4 border-b border-slate-50">
                    <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <twig:ux:icon name="tabler:plus" class="w-4 h-4 text-cyan-600" />
                        Nouveau quiz
                    </h2>
                </div>
                <div class="p-6">
                    {{ form_start(quizForm, {'attr': {'class': 'space-y-5', 'id': 'quiz-form'}}) }}

                    <div class="grid grid-cols-2 gap-4">
                        <div class="grid gap-1.5 col-span-2">
                            <label class="text-sm font-medium text-slate-700">{{ form_label(quizForm.Titre) }}</label>
                            {{ form_widget(quizForm.Titre, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'}}) }}
                        </div>
                        <div class="grid gap-1.5">
                            <label class="text-sm font-medium text-slate-700">{{ form_label(quizForm.Type) }}</label>
                            {{ form_widget(quizForm.Type, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'placeholder': 'ex: PHP, Architecture...'}}) }}
                        </div>
                        <div class="grid gap-1.5">
                            <label class="text-sm font-medium text-slate-700">Limite temps</label>
                            {{ form_widget(quizForm.timeLimit, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'placeholder': 'secondes (vide = ∞)'}}) }}
                        </div>
                        <div class="grid gap-1.5 col-span-2">
                            <label class="text-sm font-medium text-slate-700">{{ form_label(quizForm.Mode) }}</label>
                            {{ form_widget(quizForm.Mode, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'onchange': 'onModeChange(this.value)'}}) }}
                        </div>
                    </div>

                    {# Fixed section — création inline de questions #}
                    <div id="section-fixed" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-slate-700">Questions du quiz</label>
                            <button type="button" onclick="addQuizQuestion()"
                                    class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-cyan-700 border border-cyan-200 rounded-lg hover:bg-cyan-50 transition-colors">
                                <twig:ux:icon name="tabler:plus" class="w-3 h-3" />
                                Ajouter une question
                            </button>
                        </div>
                        <div id="quiz-questions-collection"
                             data-prototype="{{ form_widget(quizForm.Questions.vars.prototype)|e('html_attr') }}"
                             data-index="{{ quizForm.Questions|length }}"
                             class="space-y-3">
                            {% for question in quizForm.Questions %}
                                {# Questions existantes (vide lors de la création) #}
                            {% endfor %}
                        </div>
                        <p class="text-xs text-slate-400">Les questions créées ici seront rattachées à votre entreprise.</p>
                    </div>

                    {# Balanced section — rules collection #}
                    <div id="section-balanced" class="space-y-3" style="display:none">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-slate-700">Règles de sélection</label>
                            <button type="button" onclick="addRule()"
                                    class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-violet-700 border border-violet-200 rounded-lg hover:bg-violet-50 transition-colors">
                                <twig:ux:icon name="tabler:plus" class="w-3 h-3" />
                                Ajouter une règle
                            </button>
                        </div>
                        <div id="rules-collection"
                             data-prototype="{{ form_widget(quizForm.Rules.vars.prototype)|e('html_attr') }}"
                             data-index="{{ quizForm.Rules|length }}"
                             class="space-y-2">
                            {% for rule in quizForm.Rules %}
                                <div class="rule-item flex items-end gap-2 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <div class="grid grid-cols-3 gap-2 flex-1">
                                        <div>
                                            <label class="text-xs text-slate-500 block mb-1">Thème</label>
                                            {{ form_widget(rule.theme, {'attr': {'class': 'w-full text-sm border border-slate-200 rounded px-2 py-1.5 bg-white'}}) }}
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 block mb-1">Niveau</label>
                                            {{ form_widget(rule.level, {'attr': {'class': 'w-full text-sm border border-slate-200 rounded px-2 py-1.5 bg-white'}}) }}
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 block mb-1">Quantité</label>
                                            {{ form_widget(rule.Quantity, {'attr': {'class': 'w-full text-sm border border-slate-200 rounded px-2 py-1.5 bg-white', 'min': '1'}}) }}
                                        </div>
                                    </div>
                                    <button type="button" onclick="this.closest('.rule-item').remove()"
                                            class="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0">
                                        <twig:ux:icon name="tabler:trash" class="w-4 h-4" />
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {{ form_rest(quizForm) }}
                    <button type="submit" class="w-full py-2.5 bg-cyan-600 text-white text-sm font-semibold rounded-xl hover:bg-cyan-700 transition-colors">
                        Créer le quiz
                    </button>
                    {{ form_end(quizForm) }}
                </div>
            </div>

            {# COMPANY QUIZ PREVIEW panels #}
            {% for quiz in companyQuizzes %}
                <div id="panel-quiz-{{ quiz.id }}" class="quiz-panel bg-white rounded-2xl border border-slate-100 shadow-sm" style="display:none">
                    <div class="px-6 py-4 border-b border-slate-50 flex items-center justify-between">
                        <div>
                            <h2 class="text-base font-bold text-slate-800">{{ quiz.titre }}</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-700">
                                    {{ quiz.mode }}
                                </span>
                                {% if quiz.type %}
                                    <span class="text-xs text-slate-400">{{ quiz.type }}</span>
                                {% endif %}
                                {% if quiz.timeLimit %}
                                    <span class="text-xs text-slate-400">
                                        <twig:ux:icon name="tabler:clock" class="w-3 h-3 inline" />
                                        {{ (quiz.timeLimit / 60)|number_format(0) }} min
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="openInviteModal()"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-cyan-700 border border-cyan-200 rounded-lg hover:bg-cyan-50 transition-colors">
                                <twig:ux:icon name="tabler:send" class="w-3.5 h-3.5" />
                                Envoyer
                            </button>
                            <form method="POST" action="{{ path('business_quiz_delete_quiz', {id: quiz.id}) }}"
                                  onsubmit="return confirm('Supprimer ce quiz ?')">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_quiz_' ~ quiz.id) }}">
                                <button type="submit"
                                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
                                    <twig:ux:icon name="tabler:trash" class="w-3.5 h-3.5" />
                                    Supprimer
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="p-6">
                        {% if quiz.mode == 'Fixed' %}
                            <h3 class="text-sm font-semibold text-slate-700 mb-3">
                                {{ quiz.questions|length }} question{{ quiz.questions|length > 1 ? 's' : '' }}
                            </h3>
                            {% if quiz.questions is empty %}
                                <p class="text-sm text-slate-400 italic">Aucune question sélectionnée.</p>
                            {% else %}
                                <div class="space-y-2">
                                    {% for q in quiz.questions %}
                                        <div class="flex items-center gap-2.5 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm text-slate-700 font-medium truncate">{{ q.titled }}</p>
                                                <div class="flex items-center gap-1.5 mt-0.5">
                                                    {% if q.level %}
                                                        <span class="text-xs px-1.5 py-0.5 rounded font-medium
                                                            {% if q.level == 'Facile' %}bg-green-100 text-green-700
                                                            {% elseif q.level == 'Moyen' %}bg-amber-100 text-amber-700
                                                            {% else %}bg-red-100 text-red-600{% endif %}">
                                                            {{ q.level }}
                                                        </span>
                                                    {% endif %}
                                                    {% if q.type %}
                                                        <span class="text-xs text-slate-400">{{ q.type }}</span>
                                                    {% endif %}
                                                    {% if q.company %}
                                                        <span class="text-xs px-1.5 py-0.5 rounded bg-violet-100 text-violet-700 font-medium">
                                                            ⭐ Entreprise
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% else %}
                            <h3 class="text-sm font-semibold text-slate-700 mb-3">
                                {{ quiz.rules|length }} règle{{ quiz.rules|length > 1 ? 's' : '' }} de sélection
                            </h3>
                            {% if quiz.rules is empty %}
                                <p class="text-sm text-slate-400 italic">Aucune règle définie.</p>
                            {% else %}
                                <div class="space-y-2">
                                    {% for rule in quiz.rules %}
                                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                            <span class="text-xs font-medium text-violet-700 bg-violet-100 px-2 py-1 rounded">{{ rule.theme }}</span>
                                            <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded">{{ rule.level }}</span>
                                            <span class="text-xs text-slate-500">× {{ rule.quantity }} questions</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}

            {# PLATFORM QUIZ PREVIEW panels #}
            {% for quiz in platformQuizzes %}
                <div id="panel-platform-quiz-{{ quiz.id }}" class="quiz-panel bg-white rounded-2xl border border-slate-100 shadow-sm" style="display:none">
                    <div class="px-6 py-4 border-b border-slate-50">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-violet-100 text-violet-700">
                                <twig:ux:icon name="tabler:globe" class="w-3 h-3" />
                                Plateforme
                            </span>
                        </div>
                        <h2 class="text-base font-bold text-slate-800">{{ quiz.titre }}</h2>
                        <p class="text-xs text-slate-400 mt-0.5">{{ quiz.mode }}{% if quiz.type %} · {{ quiz.type }}{% endif %}</p>
                    </div>
                    <div class="p-6">
                        <p class="text-sm font-semibold text-slate-700 mb-3">{{ quiz.questions|length + quiz.rules|length }} éléments</p>
                        {% if quiz.mode == 'Fixed' %}
                            <div class="space-y-1.5">
                                {% for q in quiz.questions %}
                                    <div class="flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-lg text-sm text-slate-700">
                                        <twig:ux:icon name="tabler:circle-dot" class="w-3 h-3 text-slate-400 flex-shrink-0" />
                                        <span class="truncate">{{ q.titled }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="space-y-2">
                                {% for rule in quiz.rules %}
                                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <span class="text-xs font-medium text-violet-700 bg-violet-100 px-2 py-1 rounded">{{ rule.theme }}</span>
                                        <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded">{{ rule.level }}</span>
                                        <span class="text-xs text-slate-500">× {{ rule.quantity }} questions</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        {# =================== RIGHT PANEL — QUESTIONS TAB =================== #}
        <div id="right-questions" class="tab-right flex-1 min-w-0" style="display:none">

            {# Welcome state — aperçu des stats globales #}
            <div id="panel-welcome-question" class="question-panel bg-white rounded-2xl border border-slate-100 shadow-sm flex flex-col">
                <div class="px-6 py-4 border-b border-slate-50 flex items-center justify-between">
                    <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <twig:ux:icon name="tabler:chart-bar" class="w-4 h-4 text-violet-600" />
                        Aperçu des questions
                    </h2>
                    {% if questionStats is not empty %}
                    <div class="flex gap-1">
                        <button id="sort-worst-btn" onclick="sortQuestionStats('ASC')"
                            class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition-colors">
                            <twig:ux:icon name="tabler:trending-down" class="w-3.5 h-3.5" />
                            Plus ratées
                        </button>
                        <button id="sort-best-btn" onclick="sortQuestionStats('DESC')"
                            class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-50 text-slate-600 border border-slate-200 hover:bg-slate-100 transition-colors">
                            <twig:ux:icon name="tabler:trending-up" class="w-3.5 h-3.5" />
                            Mieux réussies
                        </button>
                    </div>
                    {% endif %}
                </div>

                {% if questionStats is empty %}
                    <div class="flex-1 flex flex-col items-center justify-center p-12 text-center">
                        <twig:ux:icon name="tabler:chart-bar" class="w-12 h-12 text-slate-300 mb-4" />
                        <p class="text-slate-500 font-medium">Aucune donnée disponible</p>
                        <p class="text-xs text-slate-400 mt-1">Les statistiques apparaîtront après les premiers passages de quiz</p>
                    </div>
                {% else %}
                    <div id="question-stats-list" class="divide-y divide-slate-50 overflow-y-auto max-h-[calc(100vh-280px)]">
                        {% for stat in questionStats %}
                            {% set pct = stat.totalAttempts > 0 ? (stat.correctCount / stat.totalAttempts * 100)|round : 0 %}
                            <div class="px-6 py-3 hover:bg-slate-50 cursor-pointer group transition-colors"
                                 data-stat-id="{{ stat.id }}"
                                 data-success-rate="{{ pct }}"
                                 onclick="loadQuestionStats({{ stat.id }}, this)">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-slate-800 truncate group-hover:text-violet-700">{{ stat.titled }}</p>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            {% if stat.level %}
                                                <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium
                                                    {% if stat.level == 'Facile' %}bg-green-100 text-green-700
                                                    {% elseif stat.level == 'Moyen' %}bg-amber-100 text-amber-700
                                                    {% else %}bg-red-100 text-red-600{% endif %}">
                                                    {{ stat.level }}
                                                </span>
                                            {% endif %}
                                            {% if stat.type %}
                                                <span class="text-[10px] text-slate-400">{{ stat.type }}</span>
                                            {% endif %}
                                            <span class="text-[10px] text-slate-400">{{ stat.totalAttempts }} réponse{{ stat.totalAttempts > 1 ? 's' : '' }}</span>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <span class="text-sm font-bold
                                            {% if pct >= 70 %}text-green-600
                                            {% elseif pct >= 40 %}text-amber-600
                                            {% else %}text-red-600{% endif %}">
                                            {{ pct }}%
                                        </span>
                                    </div>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5">
                                    <div class="h-1.5 rounded-full transition-all
                                        {% if pct >= 70 %}bg-green-500
                                        {% elseif pct >= 40 %}bg-amber-400
                                        {% else %}bg-red-500{% endif %}"
                                        style="width: {{ pct }}%"></div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <script>
            function sortQuestionStats(order) {
                const list = document.getElementById('question-stats-list');
                if (!list) return;
                const rows = Array.from(list.querySelectorAll('[data-stat-id]'));
                rows.sort((a, b) => {
                    const ra = parseFloat(a.dataset.successRate);
                    const rb = parseFloat(b.dataset.successRate);
                    return order === 'ASC' ? ra - rb : rb - ra;
                });
                rows.forEach(r => list.appendChild(r));

                const worstBtn = document.getElementById('sort-worst-btn');
                const bestBtn  = document.getElementById('sort-best-btn');
                if (order === 'ASC') {
                    worstBtn.className = worstBtn.className.replace('bg-slate-50 text-slate-600 border-slate-200', 'bg-red-50 text-red-700 border-red-200');
                    bestBtn.className  = bestBtn.className.replace('bg-red-50 text-red-700 border-red-200', 'bg-slate-50 text-slate-600 border-slate-200');
                } else {
                    bestBtn.className  = bestBtn.className.replace('bg-slate-50 text-slate-600 border-slate-200', 'bg-green-50 text-green-700 border-green-200');
                    worstBtn.className = worstBtn.className.replace('bg-red-50 text-red-700 border-red-200', 'bg-slate-50 text-slate-600 border-slate-200');
                }
            }
            </script>

            {# NEW QUESTION FORM #}
            <div id="panel-new-question" class="question-panel bg-white rounded-2xl border border-slate-100 shadow-sm" style="display:none">
                <div class="px-6 py-4 border-b border-slate-50">
                    <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <twig:ux:icon name="tabler:plus" class="w-4 h-4 text-violet-600" />
                        Nouvelle question
                    </h2>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(100vh-280px)]">
                    {{ form_start(questionForm, {'attr': {'class': 'space-y-4', 'id': 'question-form'}}) }}

                    <div class="grid gap-1.5">
                        <label class="text-sm font-medium text-slate-700">{{ form_label(questionForm.titled) }}</label>
                        {{ form_widget(questionForm.titled, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'placeholder': 'Intitulé de la question'}}) }}
                    </div>
                    <div class="grid gap-1.5">
                        <label class="text-sm font-medium text-slate-700">{{ form_label(questionForm.Description) }}</label>
                        {{ form_widget(questionForm.Description, {'attr': {'class': 'flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'rows': '2'}}) }}
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="grid gap-1.5">
                            <label class="text-sm font-medium text-slate-700">{{ form_label(questionForm.level) }}</label>
                            {{ form_widget(questionForm.level, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'}}) }}
                        </div>
                        <div class="grid gap-1.5">
                            <label class="text-sm font-medium text-slate-700">{{ form_label(questionForm.type) }}</label>
                            {{ form_widget(questionForm.type, {'attr': {'class': 'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'}}) }}
                        </div>
                    </div>

                    {# Answers collection #}
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">Réponses</label>
                            <button type="button" onclick="addAnswer()"
                                    class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-violet-700 border border-violet-200 rounded-lg hover:bg-violet-50 transition-colors">
                                <twig:ux:icon name="tabler:plus" class="w-3 h-3" />
                                Ajouter
                            </button>
                        </div>
                        <div id="answers-collection"
                             data-prototype="{{ form_widget(questionForm.Reponses.vars.prototype)|e('html_attr') }}"
                             data-index="{{ questionForm.Reponses|length }}"
                             class="space-y-3">
                            {% for answer in questionForm.Reponses %}
                                <div class="answer-item bg-slate-50 border border-slate-200 rounded-xl p-3 space-y-2">
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="flex-1">
                                            <label class="text-xs text-slate-500 block mb-1">Texte de la réponse</label>
                                            {{ form_widget(answer.text, {'attr': {'class': 'flex w-full rounded-md border border-input bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'}}) }}
                                        </div>
                                        <div class="flex flex-col items-center gap-1 flex-shrink-0 pt-4">
                                            <label class="text-xs text-slate-500">Correct</label>
                                            {{ form_widget(answer.is_correct, {'attr': {'class': 'w-4 h-4 accent-green-600'}}) }}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500 block mb-1">Feedback</label>
                                        {{ form_widget(answer.feedback, {'attr': {'class': 'flex w-full rounded-md border border-input bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring', 'placeholder': 'Explication optionnelle...'}}) }}
                                    </div>
                                    <button type="button" onclick="this.closest('.answer-item').remove()"
                                            class="text-xs text-red-500 hover:text-red-700 transition-colors">
                                        ✕ Supprimer cette réponse
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {{ form_rest(questionForm) }}
                    <button type="submit" class="w-full py-2.5 bg-violet-600 text-white text-sm font-semibold rounded-xl hover:bg-violet-700 transition-colors">
                        Créer la question
                    </button>
                    {{ form_end(questionForm) }}
                </div>
            </div>

            {# Question DETAIL panel (AJAX) #}
            <div id="panel-question-detail" class="question-panel bg-white rounded-2xl border border-slate-100 shadow-sm" style="display:none">
                <div id="question-detail-content" class="p-6">
                    {# Filled by loadQuestionStats() #}
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// ————————————————————————————————————————
// Config
// ————————————————————————————————————————
const STATS_BASE_URL = '{{ statsUrl }}';

// ————————————————————————————————————————
// Tab switching
// ————————————————————————————————————————
function switchTab(tab) {
    document.querySelectorAll('.tab-left, .tab-right').forEach(el => el.style.display = 'none');
    document.getElementById('left-' + tab).style.display = 'flex';
    document.getElementById('right-' + tab).style.display = 'block';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-slate-100', 'text-slate-800');
        btn.classList.add('text-slate-500');
    });
    const activeBtn = document.getElementById('tab-btn-' + tab);
    activeBtn.classList.remove('text-slate-500');
    activeBtn.classList.add('bg-slate-100', 'text-slate-800');
}

// ————————————————————————————————————————
// Quiz panels
// ————————————————————————————————————————
function showQuizPanel(panelId) {
    document.querySelectorAll('#right-quiz .quiz-panel').forEach(p => p.style.display = 'none');
    const panel = document.getElementById(panelId);
    if (panel) panel.style.display = 'block';

    // Highlight active quiz in list
    document.querySelectorAll('.quiz-item').forEach(i => i.classList.remove('bg-cyan-50'));
    if (panelId.startsWith('panel-quiz-')) {
        const id = panelId.replace('panel-quiz-', '');
        document.querySelectorAll(`.quiz-item[onclick*="panel-quiz-${id}"]`).forEach(i => i.classList.add('bg-cyan-50'));
    }
}

// ————————————————————————————————————————
// Question panels
// ————————————————————————————————————————
function showQuestionPanel(panelId) {
    document.querySelectorAll('#right-questions .question-panel').forEach(p => p.style.display = 'none');
    const panel = document.getElementById(panelId);
    if (panel) panel.style.display = 'block';
}

function loadQuestionStats(id, el) {
    // Highlight
    document.querySelectorAll('.question-item').forEach(i => {
        i.classList.remove('bg-violet-50', 'border-l-2', 'border-violet-400');
    });
    if (el) {
        el.classList.add('bg-violet-50', 'border-l-2', 'border-violet-400');
    }

    showQuestionPanel('panel-question-detail');
    const content = document.getElementById('question-detail-content');
    content.innerHTML = '<div class="flex items-center justify-center py-12 text-slate-400 text-sm">Chargement...</div>';

    const url = STATS_BASE_URL.replace('/0/', '/' + id + '/');
    fetch(url)
        .then(r => r.json())
        .then(data => renderQuestionDetail(data, content))
        .catch(() => {
            content.innerHTML = '<p class="text-red-500 text-sm">Erreur lors du chargement.</p>';
        });
}

function renderQuestionDetail(data, container) {
    const levelColor = {'Facile': 'green', 'Moyen': 'amber', 'Difficile': 'red'}[data.level] || 'slate';
    const ownerBadge = data.isCompany
        ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-violet-100 text-violet-700">⭐ Entreprise</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500">Plateforme</span>';

    let answersHtml = '';
    data.answers.forEach(a => {
        const barColor = a.isCorrect ? 'bg-green-500' : 'bg-slate-300';
        const textColor = a.isCorrect ? 'text-green-700 font-semibold' : 'text-slate-600';
        const tick = a.isCorrect ? '✓ ' : '';
        answersHtml += `
            <div class="space-y-1">
                <div class="flex items-center justify-between text-sm">
                    <span class="${textColor}">${tick}${escHtml(a.text)}</span>
                    <span class="text-xs text-slate-400 ml-2 flex-shrink-0">${a.count} (${a.pct}%)</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-5 overflow-hidden">
                    <div class="${barColor} h-5 rounded-full transition-all duration-500 flex items-center justify-end pr-1"
                         style="width: max(${a.pct}%, ${a.count > 0 ? 1 : 0}%)">
                        ${a.pct > 10 ? `<span class="text-white text-xs font-bold">${a.pct}%</span>` : ''}
                    </div>
                </div>
            </div>`;
    });

    const totalHtml = data.total > 0
        ? `<p class="text-xs text-slate-400 mt-4">${data.total} réponse${data.total > 1 ? 's' : ''} au total</p>`
        : `<p class="text-xs text-slate-400 mt-4">Aucune réponse enregistrée pour cette question.</p>`;

    container.innerHTML = `
        <div class="space-y-5">
            <div>
                <div class="flex items-center gap-2 flex-wrap mb-2">
                    ${ownerBadge}
                    ${data.level ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${levelColor}-100 text-${levelColor}-700">${data.level}</span>` : ''}
                    ${data.type ? `<span class="text-xs text-slate-400">${data.type}</span>` : ''}
                </div>
                <h2 class="text-lg font-bold text-slate-900">${escHtml(data.titled)}</h2>
                ${data.description ? `<p class="text-sm text-slate-500 mt-1">${escHtml(data.description)}</p>` : ''}
            </div>
            <div>
                <h3 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    Distribution des réponses
                </h3>
                <div class="space-y-3">${answersHtml || '<p class="text-sm text-slate-400 italic">Aucune réponse définie.</p>'}</div>
                ${totalHtml}
            </div>
        </div>`;
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
}

// ————————————————————————————————————————
// Mode switcher (Fixed / Balanced)
// ————————————————————————————————————————
function onModeChange(mode) {
    const fixedSection = document.getElementById('section-fixed');
    const balancedSection = document.getElementById('section-balanced');

    if (mode === 'Fixed') {
        fixedSection.style.display = 'block';
        fixedSection.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        balancedSection.style.display = 'none';
        balancedSection.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
    } else {
        balancedSection.style.display = 'block';
        balancedSection.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        fixedSection.style.display = 'none';
        fixedSection.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
    }
}

// ————————————————————————————————————————
// Quiz Questions collection (Fixed mode — inline creation)
// ————————————————————————————————————————
function addQuizQuestion() {
    const container = document.getElementById('quiz-questions-collection');
    const qIdx = parseInt(container.dataset.index);
    const proto = container.dataset.prototype;
    const html = proto.replace(/__question_idx__/g, qIdx);
    container.dataset.index = qIdx + 1;

    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    // Apply styles to form controls
    tmp.querySelectorAll('input[type="text"]').forEach(el => {
        el.className = 'flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-500';
    });
    tmp.querySelectorAll('textarea').forEach(el => {
        el.className = 'flex w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-500';
        el.setAttribute('rows', '2');
    });
    tmp.querySelectorAll('select').forEach(el => {
        el.className = 'flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-500';
    });

    // Extract fields
    const titledInput = tmp.querySelector('input[type="text"]');
    const descTextarea = tmp.querySelector('textarea');
    const selects = tmp.querySelectorAll('select');
    const levelSelect = selects[0];
    const typeSelect = selects[1];
    const answersContainer = tmp.querySelector('[data-prototype]');
    if (answersContainer) {
        answersContainer.className = 'space-y-2';
        answersContainer.dataset.answerIndex = '0';
    }

    const card = document.createElement('div');
    card.className = 'question-wrapper border border-slate-200 rounded-xl overflow-hidden';
    card.innerHTML = `
        <div class="flex items-center justify-between px-4 py-2.5 bg-slate-100 border-b border-slate-200">
            <span class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Question ${qIdx + 1}</span>
            <button type="button" onclick="this.closest('.question-wrapper').remove()"
                    class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="p-4 space-y-3">
            <div class="grid gap-1">
                <label class="text-xs font-medium text-slate-600">Intitulé</label>
                ${titledInput ? titledInput.outerHTML : ''}
            </div>
            <div class="grid gap-1">
                <label class="text-xs font-medium text-slate-600">Description</label>
                ${descTextarea ? descTextarea.outerHTML : ''}
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="grid gap-1">
                    <label class="text-xs font-medium text-slate-600">Niveau</label>
                    ${levelSelect ? levelSelect.outerHTML : ''}
                </div>
                <div class="grid gap-1">
                    <label class="text-xs font-medium text-slate-600">Thème</label>
                    ${typeSelect ? typeSelect.outerHTML : ''}
                </div>
            </div>
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs font-medium text-slate-600">Réponses</label>
                    <button type="button" onclick="addQuizAnswer(this)"
                            class="text-xs text-cyan-600 hover:text-cyan-800 font-medium transition-colors">
                        + Réponse
                    </button>
                </div>
                ${answersContainer ? answersContainer.outerHTML : '<div class="space-y-2"></div>'}
            </div>
        </div>`;

    container.appendChild(card);
}

function addQuizAnswer(btn) {
    const wrapper = btn.closest('.question-wrapper');
    const answersContainer = wrapper.querySelector('[data-prototype]');
    if (!answersContainer) return;

    const answerIdx = parseInt(answersContainer.dataset.answerIndex || '0');
    const proto = answersContainer.dataset.prototype;
    const html = proto.replace(/__answer_idx__/g, answerIdx);
    answersContainer.dataset.answerIndex = answerIdx + 1;

    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    tmp.querySelectorAll('input[type="text"], textarea').forEach(el => {
        el.className = 'flex w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring';
    });
    tmp.querySelectorAll('input[type="checkbox"]').forEach(el => {
        el.className = 'w-4 h-4 accent-green-600';
    });

    const allTextInputs = tmp.querySelectorAll('input[type="text"], textarea');
    const textEl = allTextInputs[0];
    const checkboxEl = tmp.querySelector('input[type="checkbox"]');
    const feedbackEl = allTextInputs[1];

    const div = document.createElement('div');
    div.className = 'answer-item bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-2';
    div.innerHTML = `
        <div class="flex items-start gap-2">
            <div class="flex-1">
                <label class="text-xs text-slate-500 block mb-1">Texte de la réponse</label>
                ${textEl ? textEl.outerHTML : ''}
            </div>
            <div class="flex flex-col items-center gap-1 pt-5 shrink-0">
                <label class="text-xs text-slate-500">✓</label>
                ${checkboxEl ? checkboxEl.outerHTML : ''}
            </div>
        </div>
        ${feedbackEl ? `<div>
            <label class="text-xs text-slate-500 block mb-1">Feedback</label>
            ${feedbackEl.outerHTML}
        </div>` : ''}
        <button type="button" onclick="this.closest('.answer-item').remove()"
                class="text-xs text-red-500 hover:text-red-700 transition-colors">✕ Supprimer</button>`;

    answersContainer.appendChild(div);
}

// ————————————————————————————————————————
// Rules collection (CollectionType)
// ————————————————————————————————————————
function addRule() {
    const collection = document.getElementById('rules-collection');
    const prototype = collection.getAttribute('data-prototype');
    let index = parseInt(collection.getAttribute('data-index') || '0');
    const html = prototype.replace(/__name__/g, index);
    collection.setAttribute('data-index', index + 1);

    const div = document.createElement('div');
    div.className = 'rule-item flex items-end gap-2 p-3 bg-slate-50 rounded-lg border border-slate-100';
    div.innerHTML = `
        <div class="grid grid-cols-3 gap-2 flex-1">` + buildRuleInner(html) + `</div>
        <button type="button" onclick="this.closest('.rule-item').remove()"
                class="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>`;

    // Style the selects/inputs inside
    div.querySelectorAll('select, input').forEach(el => {
        el.className = 'w-full text-sm border border-slate-200 rounded px-2 py-1.5 bg-white';
    });
    collection.appendChild(div);
}

function buildRuleInner(html) {
    // Extract the 3 field divs from prototype HTML
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const selects = tmp.querySelectorAll('select, input[type="number"]');
    let result = '';
    const labels = ['Thème', 'Niveau', 'Quantité'];
    selects.forEach((el, i) => {
        el.className = 'w-full text-sm border border-slate-200 rounded px-2 py-1.5 bg-white';
        result += `<div><label class="text-xs text-slate-500 block mb-1">${labels[i] || ''}</label>${el.outerHTML}</div>`;
    });
    return result;
}

// ————————————————————————————————————————
// Answers collection (CollectionType)
// ————————————————————————————————————————
function addAnswer() {
    const collection = document.getElementById('answers-collection');
    const prototype = collection.getAttribute('data-prototype');
    let index = parseInt(collection.getAttribute('data-index') || '0');
    const html = prototype.replace(/__answer_idx__/g, index);
    collection.setAttribute('data-index', index + 1);

    const div = document.createElement('div');
    div.className = 'answer-item bg-slate-50 border border-slate-200 rounded-xl p-3 space-y-2';

    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    // Style inputs/textareas/checkboxes
    tmp.querySelectorAll('textarea, input[type="text"]').forEach(el => {
        el.className = 'flex w-full rounded-md border border-input bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring';
    });
    tmp.querySelectorAll('input[type="checkbox"]').forEach(el => {
        el.className = 'w-4 h-4 accent-green-600';
    });

    const textEl = tmp.querySelector('textarea, input[type="text"]');
    const checkboxEl = tmp.querySelector('input[type="checkbox"]');
    const feedbackEl = tmp.querySelectorAll('textarea, input[type="text"]')[1];

    div.innerHTML = `
        <div class="flex items-center justify-between gap-2">
            <div class="flex-1">
                <label class="text-xs text-slate-500 block mb-1">Texte de la réponse</label>
                ${textEl ? textEl.outerHTML : ''}
            </div>
            <div class="flex flex-col items-center gap-1 flex-shrink-0 pt-4">
                <label class="text-xs text-slate-500">Correct</label>
                ${checkboxEl ? checkboxEl.outerHTML : ''}
            </div>
        </div>
        <div>
            <label class="text-xs text-slate-500 block mb-1">Feedback</label>
            ${feedbackEl ? feedbackEl.outerHTML : ''}
        </div>
        <button type="button" onclick="this.closest('.answer-item').remove()"
                class="text-xs text-red-500 hover:text-red-700 transition-colors">
            ✕ Supprimer cette réponse
        </button>`;

    collection.appendChild(div);
}

// ————————————————————————————————————————
// Init
// ————————————————————————————————————————
document.addEventListener('DOMContentLoaded', () => {
    const activeTab = '{{ activeTab }}';
    switchTab(activeTab);

    // Show new-quiz panel by default on quiz tab
    if (activeTab === 'quiz') {
        showQuizPanel('panel-new-quiz');
    }

    // Init mode switcher based on current value
    const modeSelect = document.querySelector('#quiz-form select[name*="Mode"]');
    if (modeSelect) onModeChange(modeSelect.value);
});
</script>
{% endblock %}
